<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#080a0c"/>
<title>ğŸ‘‘ KING'S TRACKER</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOKENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#080a0c; --s1:#0f1214; --s2:#161b1e; --s3:#1d2428;
  --border:#1f2a2f; --border2:#263035;
  --gold:#d4a017; --gold2:#f0c040; --gold-dim:rgba(212,160,23,.12);
  --green:#1db954; --green-dim:rgba(29,185,84,.12);
  --red:#e53935; --red-dim:rgba(229,57,53,.10);
  --blue:#1e88e5; --blue-dim:rgba(30,136,229,.12);
  --text:#e8edf0; --muted:#5a6a72; --muted2:#3a4a52;
  --fh:'Bebas Neue',sans-serif; --fb:'Barlow',sans-serif; --fc:'Barlow Condensed',sans-serif;
  --r:12px; --r-sm:8px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent;}
body{font-family:var(--fb);background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;
  background-image:radial-gradient(ellipse 70% 50% at 5% 10%,rgba(212,160,23,.05) 0%,transparent 55%),
    radial-gradient(ellipse 50% 70% at 95% 90%,rgba(29,185,84,.03) 0%,transparent 55%);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DESKTOP SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  position:fixed;top:0;left:0;bottom:0;width:68px;
  background:var(--s1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
  padding:16px 0 24px;gap:4px;z-index:200;}
.logo{font-family:var(--fh);font-size:1.5rem;color:var(--gold);
  margin-bottom:20px;letter-spacing:1px;line-height:1;}
.nb{width:44px;height:44px;border:none;border-radius:10px;
  background:transparent;color:var(--muted);font-size:1.2rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:.18s;position:relative;}
.nb:hover{background:var(--s2);color:var(--text);}
.nb.on{background:var(--gold-dim);color:var(--gold);box-shadow:inset 0 0 0 1px rgba(212,160,23,.18);}
.nb .tip{position:absolute;left:56px;background:#000;color:#fff;
  font-family:var(--fc);font-size:.7rem;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;padding:5px 9px;border-radius:6px;white-space:nowrap;
  pointer-events:none;opacity:0;transition:.12s;z-index:300;}
.nb:hover .tip{opacity:1;}
.sb-gap{flex:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;
  background:rgba(15,18,20,.95);backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 0 calc(8px + var(--safe-bottom));
  z-index:200;flex-direction:row;justify-content:space-around;align-items:center;}
.bnb{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  border:none;background:transparent;color:var(--muted);padding:6px 4px;
  cursor:pointer;transition:.15s;font-size:.6rem;font-family:var(--fc);
  font-weight:700;letter-spacing:.5px;text-transform:uppercase;}
.bnb .ico{font-size:1.3rem;line-height:1;transition:.15s;}
.bnb.on{color:var(--gold);}
.bnb.on .ico{transform:translateY(-2px);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app{margin-left:68px;min-height:100vh;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{
  padding:18px 28px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,rgba(212,160,23,.04) 0%,transparent 40%);
  position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.topbar-l h1{font-family:var(--fh);font-size:1.8rem;color:var(--gold);letter-spacing:2px;line-height:1;}
.topbar-l p{color:var(--muted);font-size:.72rem;margin-top:2px;letter-spacing:.5px;text-transform:uppercase;}
.topbar-r{display:flex;gap:8px;align-items:center;}
.dpill{background:var(--s2);border:1px solid var(--border);border-radius:20px;
  padding:6px 13px;font-family:var(--fc);font-size:.82rem;font-weight:600;letter-spacing:.3px;}
.spill{display:flex;align-items:center;gap:5px;padding:5px 11px;
  background:var(--s2);border:1px solid var(--border);border-radius:20px;
  font-family:var(--fc);font-size:.68rem;font-weight:700;letter-spacing:.5px;
  text-transform:uppercase;color:var(--muted);}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:.3s;flex-shrink:0;}
.sdot.ok{background:var(--green);box-shadow:0 0 5px rgba(29,185,84,.4);}
.sdot.err{background:var(--red);}
.sdot.spin{animation:blink .8s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page{display:none;padding:24px 28px;padding-bottom:32px;}
.page.on{display:block;animation:fu .22s ease;}
@keyframes fu{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SECTION TITLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec{font-family:var(--fc);font-size:.75rem;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:var(--muted);margin-bottom:13px;
  display:flex;align-items:center;gap:10px;}
.sec::after{content:'';flex:1;height:1px;background:var(--border);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STAT CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px;}
.sc{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);
  padding:16px 14px;position:relative;overflow:hidden;}
.sc::after{content:'';position:absolute;top:-20px;right:-20px;width:70px;height:70px;
  border-radius:50%;background:radial-gradient(circle,rgba(212,160,23,.07) 0%,transparent 70%);}
.sc-lbl{font-size:.63rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);
  margin-bottom:6px;font-weight:700;}
.sc-val{font-family:var(--fh);font-size:2rem;line-height:1;color:var(--gold);}
.sc-sub{font-size:.72rem;color:var(--muted);margin-top:3px;}
.sc.c-g .sc-val{color:var(--green);}
.sc.c-b .sc-val{color:var(--blue);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PERF RING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.perf{display:grid;grid-template-columns:auto 1fr;gap:20px;align-items:center;
  background:var(--s1);border:1px solid var(--border);border-radius:var(--r);
  padding:20px;margin-bottom:22px;}
.ring{position:relative;width:96px;height:96px;flex-shrink:0;}
.ring svg{transform:rotate(-90deg);}
.ring-txt{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;}
.ring-pct{font-family:var(--fh);font-size:1.5rem;color:var(--gold);}
.ring-lbl{font-size:.55rem;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);}
.perf-r h2{font-family:var(--fh);font-size:1.4rem;letter-spacing:1px;margin-bottom:4px;}
.perf-r p{color:var(--muted);font-size:.82rem;line-height:1.5;}
.coach{margin-top:9px;font-size:.8rem;font-weight:600;padding:7px 12px;border-radius:7px;
  display:inline-block;background:var(--gold-dim);color:var(--gold);border-left:3px solid var(--gold);}
.coach.g{background:var(--green-dim);color:var(--green);border-color:var(--green);}
.coach.r{background:var(--red-dim);color:var(--red);border-color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HABIT PILLS (dashboard) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:22px;}
.hp{background:var(--s1);border:1px solid var(--border);border-radius:10px;
  padding:12px 14px;display:flex;align-items:center;gap:10px;
  cursor:pointer;transition:.18s;-webkit-tap-highlight-color:transparent;}
.hp:hover{border-color:var(--border2);background:var(--s2);}
.hp:active{transform:scale(.97);}
.hp.done{border-color:rgba(29,185,84,.3);background:var(--green-dim);}
.hem{width:32px;height:32px;border-radius:7px;background:var(--s2);
  display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.hp.done .hem{background:rgba(29,185,84,.15);}
.hi{flex:1;min-width:0;}
.hn{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hv{font-size:.72rem;color:var(--muted);margin-top:2px;}
.hp.done .hv{color:var(--green);}
.hchk{width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border2);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.6rem;}
.hp.done .hchk{background:var(--green);border-color:var(--green);color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px;}
.cc{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px;}
.cc h3{font-family:var(--fc);font-size:.72rem;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);margin-bottom:13px;}
.cc canvas{max-height:185px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEATMAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hmap{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:22px;}
.hmc{aspect-ratio:1;border-radius:5px;background:var(--s2);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:.52rem;color:var(--muted);position:relative;cursor:default;}
.hmc[data-l="1"]{background:rgba(212,160,23,.16);}
.hmc[data-l="2"]{background:rgba(212,160,23,.35);}
.hmc[data-l="3"]{background:rgba(212,160,23,.60);}
.hmc[data-l="4"]{background:var(--gold);color:#000;}
.hmtip{display:none;position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
  background:#000;color:#fff;font-size:.6rem;padding:4px 8px;border-radius:5px;
  white-space:nowrap;z-index:20;pointer-events:none;}
.hmc:hover .hmtip{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.banner{border-radius:10px;padding:12px 16px;margin-bottom:18px;font-size:.82rem;
  display:flex;align-items:center;gap:10px;line-height:1.4;}
.banner.warn{background:rgba(212,160,23,.07);border:1px solid rgba(212,160,23,.18);color:var(--gold);}
.banner.ok{background:var(--green-dim);border:1px solid rgba(29,185,84,.18);color:var(--green);}
.banner.err{background:var(--red-dim);border:1px solid rgba(229,57,53,.18);color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ENTRY FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ewrap{max-width:580px;margin:0 auto;}
.ehead{text-align:center;margin-bottom:24px;}
.ehead h2{font-family:var(--fh);font-size:2rem;letter-spacing:2px;color:var(--gold);}
.ehead p{color:var(--muted);font-size:.82rem;margin-top:5px;}

.ecard{background:var(--s1);border:1.5px solid var(--border);border-radius:var(--r);
  padding:18px;margin-bottom:12px;transition:.18s;}
.ecard:focus-within{border-color:rgba(212,160,23,.3);}
.ecard.answered{border-color:rgba(29,185,84,.28);}
.etop{display:flex;align-items:center;gap:11px;margin-bottom:14px;}
.eico{width:40px;height:40px;border-radius:9px;background:var(--s2);
  display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.elbl{font-family:var(--fc);font-size:1rem;font-weight:700;letter-spacing:.3px;}
.eq{font-size:.77rem;color:var(--muted);margin-top:2px;line-height:1.4;}

/* Toggle */
.trow{display:flex;gap:8px;}
.tog{flex:1;border:1.5px solid var(--border);border-radius:var(--r-sm);padding:13px;
  background:transparent;color:var(--muted);font-family:var(--fc);
  font-size:.9rem;font-weight:700;letter-spacing:.5px;cursor:pointer;transition:.18s;
  min-height:48px;}
.tog:hover{border-color:var(--gold);color:var(--gold);}
.tog.yes.on{background:var(--green-dim);border-color:var(--green);color:var(--green);}
.tog.no.on{background:var(--red-dim);border-color:var(--red);color:var(--red);}

/* Number */
.nrow{display:flex;align-items:center;gap:8px;}
.nbtn{width:44px;height:44px;border-radius:var(--r-sm);border:none;
  background:var(--s2);color:var(--text);font-size:1.2rem;cursor:pointer;
  transition:.15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.nbtn:hover{background:var(--s3);color:var(--gold);}
.nbtn:active{transform:scale(.92);}
.nbtn.x10{width:52px;font-size:.72rem;font-family:var(--fc);font-weight:700;}
.ninp{flex:1;text-align:center;background:var(--s2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);padding:10px;color:var(--text);font-family:var(--fc);
  font-size:1.3rem;font-weight:700;outline:none;transition:.18s;min-height:48px;}
.ninp:focus{border-color:var(--gold);}

/* Slider */
.slw{display:flex;flex-direction:column;gap:8px;}
.slv{font-family:var(--fh);font-size:1.8rem;color:var(--gold);text-align:center;}
.sllbl{display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted);}
input[type=range]{width:100%;appearance:none;height:5px;border-radius:3px;
  background:var(--s2);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{appearance:none;width:22px;height:22px;
  border-radius:50%;background:var(--gold);cursor:pointer;transition:.15s;}
input[type=range]::-webkit-slider-thumb:hover{background:var(--gold2);transform:scale(1.12);}

/* Pray */
.prow{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
.pbt{min-width:52px;height:48px;border-radius:var(--r-sm);
  border:1.5px solid var(--border);background:transparent;color:var(--muted);
  font-size:.88rem;cursor:pointer;transition:.18s;
  display:flex;align-items:center;justify-content:center;padding:0 8px;
  font-family:var(--fc);font-weight:700;}
.pbt:hover{border-color:var(--gold);}
.pbt.on{background:var(--gold-dim);border-color:var(--gold);color:var(--gold);}

/* Notes / Link */
.ntarea{width:100%;background:var(--s2);border:1.5px solid var(--border);
  border-radius:var(--r-sm);padding:12px 14px;color:var(--text);
  font-family:var(--fb);font-size:.88rem;outline:none;transition:.18s;
  resize:vertical;min-height:90px;line-height:1.55;}
.ntarea:focus{border-color:var(--gold);}
.ntarea::placeholder{color:var(--muted);}
.link-hint{font-size:.7rem;color:var(--muted);margin-top:5px;display:flex;align-items:center;gap:4px;}

/* Submit */
.subm{width:100%;border:none;border-radius:var(--r);margin-top:6px;
  background:linear-gradient(135deg,var(--gold) 0%,#e8b820 100%);
  color:#0a0800;font-family:var(--fh);font-size:1.25rem;letter-spacing:2px;
  padding:16px;cursor:pointer;transition:.2s;
  display:flex;align-items:center;justify-content:center;gap:9px;min-height:54px;}
.subm:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(212,160,23,.2);}
.subm:active{transform:translateY(0);}
.subm:disabled{opacity:.45;cursor:not-allowed;transform:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HISTORY TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.twrap{overflow-x:auto;border-radius:var(--r);border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:.82rem;}
thead tr{background:var(--s2);}
th{padding:11px 13px;text-align:left;color:var(--muted);font-family:var(--fc);
  font-size:.7rem;letter-spacing:1px;text-transform:uppercase;
  border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:11px 13px;border-bottom:1px solid rgba(31,42,47,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}
.cv{display:inline-flex;align-items:center;justify-content:center;
  min-width:30px;height:22px;border-radius:5px;
  font-family:var(--fc);font-weight:700;font-size:.8rem;padding:0 7px;}
.cv.g{background:var(--green-dim);color:var(--green);}
.cv.n{background:var(--s2);color:var(--muted);}
.cv.link a{color:var(--blue);text-decoration:none;word-break:break-all;}
.cv.link a:hover{text-decoration:underline;}
.cv.note-val{background:var(--s2);color:var(--text);font-size:.75rem;
  height:auto;padding:4px 8px;white-space:normal;max-width:200px;
  text-align:left;line-height:1.4;}
.dcol{font-family:var(--fc);font-weight:700;font-size:.86rem;white-space:nowrap;}
.today-row td{background:rgba(212,160,23,.035);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rep-grid{display:grid;grid-template-columns:1fr;gap:22px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.scard{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:20px;}
.scard h3{font-family:var(--fc);font-size:.75rem;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--muted);margin-bottom:13px;}
.fg{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
.fl{font-size:.7rem;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;font-weight:700;}
.fi{background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r-sm);
  padding:10px 13px;color:var(--text);font-family:inherit;font-size:.88rem;
  outline:none;transition:.18s;width:100%;min-height:44px;}
.fi:focus{border-color:var(--gold);}
.fi option{background:var(--s2);}

/* Buttons */
.btn{border:none;border-radius:var(--r-sm);padding:10px 16px;font-family:var(--fc);
  font-size:.85rem;font-weight:700;letter-spacing:.5px;cursor:pointer;
  transition:.18s;display:inline-flex;align-items:center;gap:6px;min-height:44px;}
.btn-g{background:var(--gold);color:#000;}
.btn-g:hover{background:var(--gold2);}
.btn-g:active{transform:scale(.96);}
.btn-r{background:var(--red-dim);color:var(--red);border:1px solid rgba(229,57,53,.2);}
.btn-r:hover{background:rgba(229,57,53,.18);}
.btn-m{background:var(--s2);color:var(--text);border:1px solid var(--border);}
.btn-m:hover{border-color:var(--gold);color:var(--gold);}
.btn-b{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(30,136,229,.2);}
.btn-b:hover{background:rgba(30,136,229,.18);}

/* Subject list */
.slist{display:flex;flex-direction:column;gap:8px;}
.srow{background:var(--s2);border:1px solid var(--border);border-radius:10px;
  padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.srow-info .sn{font-weight:600;font-size:.86rem;}
.srow-info .sd{font-size:.72rem;color:var(--muted);margin-top:3px;line-height:1.4;}
.srow-acts{display:flex;gap:6px;flex-shrink:0;}
.icon-btn{width:34px;height:34px;border-radius:8px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:.15s;}
.edit-btn{background:var(--blue-dim);color:var(--blue);}
.edit-btn:hover{background:rgba(30,136,229,.2);}
.del-btn{background:var(--red-dim);color:var(--red);}
.del-btn:hover{background:rgba(229,57,53,.2);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);
  z-index:500;align-items:center;justify-content:center;padding:16px;}
.modal-ov.open{display:flex;animation:mfade .18s ease;}
@keyframes mfade{from{opacity:0;}to{opacity:1;}}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:16px;
  padding:24px;max-width:440px;width:100%;
  animation:mpop .2s cubic-bezier(.4,0,.2,1);max-height:90vh;overflow-y:auto;}
@keyframes mpop{from{transform:scale(.94);opacity:0;}to{transform:scale(1);opacity:1;}}
.modal h2{font-family:var(--fh);font-size:1.4rem;letter-spacing:1px;margin-bottom:5px;color:var(--gold);}
.modal p{color:var(--muted);font-size:.82rem;margin-bottom:18px;line-height:1.5;}
.modal-acts{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:calc(20px + var(--safe-bottom));right:16px;
  background:rgba(10,12,14,.95);backdrop-filter:blur(10px);
  border:1px solid var(--border2);border-radius:10px;padding:11px 16px;
  font-family:var(--fc);font-size:.86rem;font-weight:700;letter-spacing:.3px;
  color:var(--text);z-index:9999;transform:translateY(70px);opacity:0;
  transition:.25s cubic-bezier(.4,0,.2,1);pointer-events:none;max-width:300px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{border-color:rgba(29,185,84,.3);color:var(--green);}
.toast.err{border-color:rgba(229,57,53,.3);color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPINNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sp{display:inline-block;width:14px;height:14px;border:2px solid rgba(212,160,23,.2);
  border-top-color:var(--gold);border-radius:50%;animation:rot .6s linear infinite;}
@keyframes rot{to{transform:rotate(360deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ls{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:9999;transition:.4s;}
.ls.gone{opacity:0;pointer-events:none;}
.ll{font-family:var(--fh);font-size:2.6rem;color:var(--gold);letter-spacing:4px;margin-bottom:20px;}
.lb{width:160px;height:3px;background:var(--s2);border-radius:2px;overflow:hidden;}
.lbf{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));
  border-radius:2px;animation:la 1.1s ease forwards;}
@keyframes la{from{width:0}to{width:100%}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â€” MOBILE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  .sidebar{display:none;}
  .bottom-nav{display:flex;}
  .app{margin-left:0;padding-bottom:calc(70px + var(--safe-bottom));}
  .topbar{padding:14px 16px;}
  .topbar-l h1{font-size:1.4rem;}
  .topbar-l p{display:none;}
  .page{padding:16px 14px 24px;}
  .stats-row{grid-template-columns:repeat(2,1fr);gap:9px;}
  .sc{padding:13px 12px;}
  .sc-val{font-size:1.7rem;}
  .perf{grid-template-columns:1fr;text-align:center;gap:14px;padding:16px;}
  .coach{display:block;}
  .hgrid{grid-template-columns:1fr 1fr;gap:8px;}
  .hp{padding:10px 11px;gap:8px;}
  .hem{width:28px;height:28px;font-size:1rem;}
  .hn{font-size:.78rem;}
  .charts{grid-template-columns:1fr;gap:12px;}
  .sgrid{grid-template-columns:1fr;}
  .toast{bottom:calc(80px + var(--safe-bottom));right:12px;left:12px;text-align:center;}
  .modal{border-radius:14px;}
  .ewrap{max-width:100%;}
  .prow{gap:5px;}
  .pbt{min-width:44px;height:44px;}
}
@media(max-width:400px){
  .hgrid{grid-template-columns:1fr;}
  .stats-row{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="ls" id="ls">
  <div class="ll">ğŸ‘‘ KING'S TRACKER</div>
  <div class="lb"><div class="lbf"></div></div>
  <p style="margin-top:14px;color:var(--muted);font-size:.72rem;letter-spacing:1.2px;text-transform:uppercase">Loading your dataâ€¦</p>
</div>

<!-- DESKTOP SIDEBAR -->
<nav class="sidebar">
  <div class="logo">ğŸ‘‘</div>
  <button class="nb on" onclick="go('dashboard',this)">ğŸ“Š<span class="tip">Dashboard</span></button>
  <button class="nb" onclick="go('entry',this)">âœï¸<span class="tip">Daily Entry</span></button>
  <button class="nb" onclick="go('history',this)">ğŸ“…<span class="tip">History</span></button>
  <button class="nb" onclick="go('reports',this)">ğŸ“ˆ<span class="tip">Reports</span></button>
  <div class="sb-gap"></div>
  <button class="nb" onclick="go('setup',this)">âš™ï¸<span class="tip">Setup</span></button>
</nav>

<!-- MOBILE BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="bnb on" onclick="go('dashboard',this)"><span class="ico">ğŸ“Š</span>Home</button>
  <button class="bnb" onclick="go('entry',this)"><span class="ico">âœï¸</span>Log</button>
  <button class="bnb" onclick="go('history',this)"><span class="ico">ğŸ“…</span>History</button>
  <button class="bnb" onclick="go('reports',this)"><span class="ico">ğŸ“ˆ</span>Reports</button>
  <button class="bnb" onclick="go('setup',this)"><span class="ico">âš™ï¸</span>Setup</button>
</nav>

<div class="app">
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-l">
      <h1>KING'S TRACKER</h1>
      <p>Personal Performance System</p>
    </div>
    <div class="topbar-r">
      <div class="dpill" id="dpill">â€”</div>
      <div class="spill"><div class="sdot" id="sdot"></div><span id="slbl">LOCAL</span></div>
    </div>
  </header>

  <!-- â•â•â• DASHBOARD â•â•â• -->
  <div class="page on" id="page-dashboard">
    <div id="dbanner"></div>
    <div class="stats-row">
      <div class="sc"><div class="sc-lbl">Today</div><div class="sc-val" id="s-score">â€”</div><div class="sc-sub">completion</div></div>
      <div class="sc c-g"><div class="sc-lbl">Done</div><div class="sc-val" id="s-done">â€”</div><div class="sc-sub">tasks today</div></div>
      <div class="sc c-b"><div class="sc-lbl">Streak</div><div class="sc-val" id="s-streak">â€”</div><div class="sc-sub">best run</div></div>
      <div class="sc"><div class="sc-lbl">Logged</div><div class="sc-val" id="s-total">â€”</div><div class="sc-sub">total days</div></div>
    </div>

    <div class="perf">
      <div class="ring">
        <svg width="96" height="96" viewBox="0 0 96 96">
          <circle cx="48" cy="48" r="42" fill="none" stroke="#1d2428" stroke-width="6"/>
          <circle id="ringC" cx="48" cy="48" r="42" fill="none" stroke="#d4a017"
            stroke-width="6" stroke-dasharray="263.9" stroke-dashoffset="263.9"
            stroke-linecap="round" style="transition:stroke-dashoffset .9s ease"/>
        </svg>
        <div class="ring-txt">
          <div class="ring-pct" id="rpct">0%</div>
          <div class="ring-lbl">Today</div>
        </div>
      </div>
      <div class="perf-r">
        <h2 id="ptitle">LOADINGâ€¦</h2>
        <p id="psub">Pulling your dataâ€¦</p>
        <div class="coach" id="coach">Stand byâ€¦</div>
      </div>
    </div>

    <div class="sec">Today's Habits</div>
    <div class="hgrid" id="hgrid"></div>

    <div class="sec">7-Day Heatmap</div>
    <div class="hmap" id="hmap"></div>

    <div class="charts">
      <div class="cc"><h3>Weekly Activity</h3><canvas id="cw"></canvas></div>
      <div class="cc"><h3>Today's Breakdown</h3><canvas id="cs"></canvas></div>
    </div>
  </div>

  <!-- â•â•â• ENTRY â•â•â• -->
  <div class="page" id="page-entry">
    <div class="ewrap">
      <div class="ehead">
        <h2>DAILY LOG</h2>
        <p id="elbl">Loadingâ€¦</p>
      </div>
      <div id="eform"></div>
    </div>
  </div>

  <!-- â•â•â• HISTORY â•â•â• -->
  <div class="page" id="page-history">
    <div class="sec">Log History</div>
    <div class="twrap">
      <table><thead><tr id="hhead"><th>Date</th></tr></thead><tbody id="hbody"></tbody></table>
    </div>
  </div>

  <!-- â•â•â• REPORTS â•â•â• -->
  <div class="page" id="page-reports">
    <div class="rep-grid">
      <div>
        <div class="sec">Monthly Summary</div>
        <div class="twrap" style="margin-bottom:22px">
          <table><thead><tr id="mhead"><th>Month</th></tr></thead><tbody id="mbody"></tbody></table>
        </div>
      </div>
      <div>
        <div class="sec">Weekly Summary</div>
        <div class="twrap">
          <table><thead><tr id="whead"><th>Week</th></tr></thead><tbody id="wbody"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• SETUP â•â•â• -->
  <div class="page" id="page-setup">
    <div class="sgrid">

      <div class="scard">
        <h3>ğŸ”— Google Sheets Connection</h3>
        <p style="color:var(--muted);font-size:.78rem;line-height:1.55;margin-bottom:14px">
          Paste your Apps Script Web App URL. Make sure you've added the bridge code to your project and deployed a new version.
        </p>
        <div class="fg">
          <label class="fl">Apps Script Web App URL</label>
          <input class="fi" id="surl" type="url" placeholder="https://script.google.com/macros/s/â€¦/exec"/>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-g" onclick="saveUrl()">ğŸ’¾ Save & Test</button>
          <button class="btn btn-r" onclick="clearUrl()">âœ• Disconnect</button>
          <button class="btn btn-m" onclick="syncFromSheet()">â†» Sync Now</button>
        </div>
        <div id="urlst" style="margin-top:10px;font-size:.76rem;color:var(--muted)"></div>
      </div>

      <div class="scard">
        <h3>â• Add New Subject</h3>
        <div class="fg">
          <label class="fl">Name (with emoji)</label>
          <input class="fi" id="nn" placeholder="ReadingğŸ“š"/>
          <label class="fl">Daily question</label>
          <input class="fi" id="nq" placeholder="Did you read today?"/>
          <label class="fl">Input type</label>
          <select class="fi" id="nt">
            <option value="toggle">âœ… Yes / No</option>
            <option value="number">ğŸ”¢ Number</option>
            <option value="slider">ğŸšï¸ Mood Slider 1â€“10</option>
            <option value="pray">ğŸ™ Prayer Counter 0â€“5</option>
            <option value="notes">ğŸ“ Notes / Links</option>
          </select>
          <label class="fl">Default value</label>
          <input class="fi" id="nd" placeholder="0 or â³"/>
        </div>
        <button class="btn btn-g" onclick="addSubject()">â• Add Subject</button>
      </div>

      <div class="scard" style="grid-column:1/-1">
        <h3>ğŸ“‹ Current Subjects</h3>
        <div class="slist" id="slist">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• EDIT SUBJECT MODAL â•â•â• -->
<div class="modal-ov" id="editModal">
  <div class="modal">
    <h2>âœï¸ Edit Subject</h2>
    <p>Update this subject's details. Changes apply immediately on the app. Sync to sheet with the â†» button.</p>
    <div class="fg">
      <label class="fl">Name (with emoji)</label>
      <input class="fi" id="em-name" placeholder="Subject name"/>
      <label class="fl">Daily question</label>
      <input class="fi" id="em-q" placeholder="Your daily questionâ€¦"/>
      <label class="fl">Input type</label>
      <select class="fi" id="em-type">
        <option value="toggle">âœ… Yes / No</option>
        <option value="number">ğŸ”¢ Number</option>
        <option value="slider">ğŸšï¸ Mood Slider 1â€“10</option>
        <option value="pray">ğŸ™ Prayer Counter 0â€“5</option>
        <option value="notes">ğŸ“ Notes / Links</option>
      </select>
      <label class="fl">Default value</label>
      <input class="fi" id="em-def" placeholder="0 or â³"/>
    </div>
    <div class="modal-acts">
      <button class="btn btn-m" onclick="closeModal('editModal')">Cancel</button>
      <button class="btn btn-g" onclick="saveEdit()">ğŸ’¾ Save Changes</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = { url:'kt_url', subjects:'kt_subjects', history:'kt_history' };

const DEFAULT_SUBJECTS = [
  { name:'PythonğŸ',        type:'toggle', q:'Did you code Python today?',         def:'No'  },
  { name:'GYMğŸ’ª',           type:'toggle', q:'Did you hit the gym?',               def:'No'  },
  { name:'Physical MoodğŸ§ ', type:'slider', q:'How is your energy level? (1â€“10)',   def:'5'   },
  { name:'PrayğŸ™',          type:'pray',   q:'How many prayers did you complete?', def:'0'   },
  { name:'PUBGğŸ®',          type:'number', q:'How many PUBG matches today?',       def:'0'   },
  { name:'Home push upsğŸ ', type:'number', q:'How many home push-ups?',            def:'0'   },
];

let SHEET_URL  = localStorage.getItem(SK.url) || '';
let subjects   = JSON.parse(localStorage.getItem(SK.subjects) || 'null') || DEFAULT_SUBJECTS;
let history    = JSON.parse(localStorage.getItem(SK.history)  || '[]');
let todayStr   = '';
let wChart     = null, sChart = null;
let sheetOk    = false;
let editingOld = null; // for edit modal

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  todayStr = ldate(now);
  document.getElementById('dpill').textContent =
    now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  document.getElementById('elbl').textContent =
    now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('surl').value = SHEET_URL;
  ensureToday();
  renderAll();
  if (SHEET_URL) syncFromSheet(); else hideLs();
});

function ensureToday() {
  if (!history.find(r => r.date === todayStr)) {
    const checks = {};
    subjects.forEach(s => checks[s.name] = s.def || '');
    history.unshift({ date: todayStr, checks });
    saveHistory();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.nb,.bnb').forEach(b => b.classList.remove('on'));
  document.getElementById('page-' + id).classList.add('on');
  // Activate matching nav buttons on both sidebars
  const idx = ['dashboard','entry','history','reports','setup'].indexOf(id);
  document.querySelectorAll('.nb')[idx]?.classList.add('on');
  document.querySelectorAll('.bnb')[idx]?.classList.add('on');
  if (id === 'history') renderHistory();
  if (id === 'reports') renderReports();
  if (id === 'setup')   renderSubjects();
  window.scrollTo(0, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHEET SYNC â€” GET only, CORS-safe
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncFromSheet() {
  setSS('spin', 'SYNCING');
  try {
    const res  = await fetch(SHEET_URL + '?action=getData&t=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // Merge subjects from sheet
    if (data.subjects?.length) {
      const existing = subjects.map(s => s.name);
      data.subjects.forEach(name => {
        if (!existing.includes(name))
          subjects.push({ name, type: guessType(name), q: `Update ${name}`, def: '0' });
      });
      saveSubjects();
    }
    // Merge history (sheet wins for past, local wins for today)
    if (data.history?.length) {
      data.history.forEach(r => {
        if (r.date === todayStr) return;
        const i = history.findIndex(x => x.date === r.date);
        if (i === -1) history.push(r); else history[i] = r;
      });
      saveHistory();
    }
    sheetOk = true;
    setSS('ok', 'SYNCED');
    renderAll();
    toast('âœ… Synced from Google Sheets', 'ok');
  } catch (e) {
    sheetOk = false;
    setSS('err', 'LOCAL');
    renderAll();
  }
  hideLs();
}

async function pushLog(dateStr, values) {
  if (!SHEET_URL || !sheetOk) return;
  try {
    const p = new URLSearchParams({ action: 'webLog', date: dateStr });
    Object.entries(values).forEach(([k, v]) => p.append('v_' + k, v));
    const res  = await fetch(SHEET_URL + '?' + p + '&t=' + Date.now());
    const data = await res.json();
    if (data.ok) { toast('â˜ï¸ Saved to Google Sheets', 'ok'); setSS('ok','SYNCED'); }
  } catch (e) { setSS('err','OFFLINE'); }
}

async function pushAdd(name) {
  if (!SHEET_URL || !sheetOk) return;
  try { await fetch(SHEET_URL + '?action=addHabit&habit=' + encodeURIComponent(name) + '&t=' + Date.now()); } catch(e){}
}

async function pushDel(name) {
  if (!SHEET_URL || !sheetOk) return;
  try { await fetch(SHEET_URL + '?action=deleteHabit&habit=' + encodeURIComponent(name) + '&t=' + Date.now()); } catch(e){}
}

function setSS(state, label) {
  document.getElementById('sdot').className = 'sdot ' + (state==='ok'?'ok':state==='err'?'err':'spin');
  document.getElementById('slbl').textContent = label;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() { renderDash(); renderEntry(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const rec    = todayRec();
  const checks = rec.checks || {};
  const total  = subjects.length;
  let done = 0;
  subjects.forEach(s => { if (isDone(s, checks[s.name])) done++; });
  const pct = total ? Math.round(done / total * 100) : 0;

  document.getElementById('s-score').textContent  = pct + '%';
  document.getElementById('s-done').textContent   = done + '/' + total;
  document.getElementById('s-streak').textContent = bestStreak() + 'ğŸ”¥';
  document.getElementById('s-total').textContent  = history.length;

  const C = 263.9;
  document.getElementById('ringC').style.strokeDashoffset = C - (pct / 100) * C;
  document.getElementById('rpct').textContent = pct + '%';

  let title, sub, msg, cls = '';
  if (pct >= 80)      { title='KING STATUS ğŸ‘‘'; sub='Absolutely crushing it today!'; msg='ğŸ”¥ Keep this momentum â€“ nothing stops you!'; cls='g'; }
  else if (pct >= 50) { title='SOLID PROGRESS ğŸ“ˆ'; sub='More than halfway. Finish strong.'; msg='ğŸ’ª Push 10% harder â€“ don\'t stop now!'; }
  else if (pct > 0)   { title='GETTING STARTED âš¡'; sub='You\'ve begun. Complete the mission.'; msg='âš”ï¸ Reset your mindset and dominate!'; cls='r'; }
  else                { title='MISSION AWAITS ğŸ¯'; sub='No entries yet â€“ log your first habit.'; msg='â˜€ï¸ Every great day starts with the first step.'; }
  document.getElementById('ptitle').textContent = title;
  document.getElementById('psub').textContent   = sub;
  const cm = document.getElementById('coach');
  cm.textContent = msg; cm.className = 'coach ' + cls;

  // Banner
  const bn = document.getElementById('dbanner');
  if (!SHEET_URL) {
    bn.className='banner warn'; bn.innerHTML='âš ï¸ <b>Local mode.</b> Go to âš™ï¸ Setup and paste your Apps Script URL to sync with Google Sheets.';
  } else if (!sheetOk) {
    bn.className='banner err'; bn.innerHTML='ğŸ”´ <b>Sheet offline.</b> Data saving locally. Tap â†» Sync Now in Setup to retry.';
  } else {
    bn.className='banner ok'; bn.innerHTML='ğŸŸ¢ <b>Connected to Google Sheets.</b> All entries sync automatically.';
  }

  // Habit pills
  const g = document.getElementById('hgrid');
  g.innerHTML = '';
  subjects.forEach(s => {
    const v  = checks[s.name];
    const ok = isDone(s, v);
    const d  = document.createElement('div');
    d.className = 'hp' + (ok ? ' done' : '');
    d.innerHTML = `
      <div class="hem">${emj(s.name)}</div>
      <div class="hi">
        <div class="hn">${s.name}</div>
        <div class="hv">${ok ? fmtV(s, v) : 'Not logged yet'}</div>
      </div>
      <div class="hchk">${ok ? 'âœ“' : ''}</div>`;
    d.onclick = () => { go('entry', null); };
    g.appendChild(d);
  });

  renderHmap();
  renderCharts();
}

function renderHmap() {
  const hm = document.getElementById('hmap');
  hm.innerHTML = '';
  for (let i = 6; i >= 0; i--) {
    const d  = new Date(); d.setDate(d.getDate() - i);
    const ds = ldate(d);
    const r  = history.find(x => x.date === ds);
    const ch = r ? r.checks : {};
    let done = 0;
    subjects.forEach(s => { if (isDone(s, ch[s.name])) done++; });
    const p   = subjects.length ? done / subjects.length : 0;
    const lvl = p === 0 ? 0 : p < .26 ? 1 : p < .51 ? 2 : p < .76 ? 3 : 4;
    const lbl = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const c   = document.createElement('div');
    c.className = 'hmc'; c.setAttribute('data-l', lvl);
    c.innerHTML = `<span class="hmtip">${lbl}: ${Math.round(p*100)}%</span>
      <span>${d.toLocaleDateString('en-US',{weekday:'narrow'})}</span>
      <span style="font-size:.46rem;margin-top:1px">${d.getDate()}</span>`;
    hm.appendChild(c);
  }
}

function renderCharts() {
  // Weekly bar
  const wL = [], wD = [];
  for (let i = 6; i >= 0; i--) {
    const d  = new Date(); d.setDate(d.getDate() - i);
    const ds = ldate(d);
    wL.push(d.toLocaleDateString('en-US',{weekday:'short'}));
    const r  = history.find(x => x.date === ds);
    const ch = r ? r.checks : {};
    let done = 0;
    subjects.forEach(s => { if (isDone(s, ch[s.name])) done++; });
    wD.push(done);
  }
  const maxW = Math.max(...wD, 1);
  const wc = document.getElementById('cw').getContext('2d');
  if (wChart) wChart.destroy();
  wChart = new Chart(wc, {
    type:'bar',
    data:{labels:wL,datasets:[{data:wD,
      backgroundColor:wD.map(v=>v===maxW?'#d4a017':'rgba(212,160,23,.25)'),borderRadius:5}]},
    options:{plugins:{legend:{display:false}},scales:{
      x:{grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#5a6a72'}},
      y:{grid:{color:'rgba(255,255,255,.03)'},ticks:{color:'#5a6a72',stepSize:1},
         min:0,max:subjects.length||6}}}
  });

  // Subject doughnut
  const rec = todayRec(), ch = rec.checks || {};
  const sL = [], sD = [];
  const cols = ['#d4a017','#1db954','#1e88e5','#fb8c00','#ab47bc','#ef5350','#26a69a','#8d6e63'];
  subjects.forEach(s => {
    sL.push(s.name.length > 13 ? s.name.slice(0,12)+'â€¦' : s.name);
    sD.push(isDone(s, ch[s.name]) ? 1 : 0);
  });
  const sc = document.getElementById('cs').getContext('2d');
  if (sChart) sChart.destroy();
  sChart = new Chart(sc, {
    type:'doughnut',
    data:{labels:sL,datasets:[{data:sD,backgroundColor:cols.slice(0,sL.length),borderWidth:0,hoverOffset:4}]},
    options:{plugins:{legend:{position:'right',labels:{color:'#5a6a72',font:{size:10},boxWidth:10}}},cutout:'68%'}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEntry() {
  const form = document.getElementById('eform');
  const rec  = todayRec();
  const ch   = rec.checks || {};
  form.innerHTML = '';

  subjects.forEach(s => {
    const slug  = sl(s.name);
    const cur   = ch[s.name] ?? s.def;
    const card  = document.createElement('div');
    card.className = 'ecard' + (isDone(s, cur) ? ' answered' : '');
    card.id = 'ec-' + slug;

    let inp = '';
    if (s.type === 'toggle') {
      const y = cur === 'Yes', n = cur === 'No';
      inp = `<div class="trow">
        <button class="tog yes ${y?'on':''}" onclick="setTog('${slug}','Yes')">âœ… YES</button>
        <button class="tog no ${n?'on':''}" onclick="setTog('${slug}','No')">âŒ NO</button>
      </div>`;
    } else if (s.type === 'slider') {
      const v = cur && !isNaN(cur) ? +cur : 5;
      inp = `<div class="slw">
        <div class="slv" id="sv-${slug}">${v}/10</div>
        <input type="range" min="1" max="10" value="${v}" id="sl-${slug}"
          oninput="document.getElementById('sv-${slug}').textContent=this.value+'/10';markA('${slug}')"/>
        <div class="sllbl"><span>ğŸ˜´ Exhausted</span><span>âš¡ On Fire</span></div>
      </div>`;
    } else if (s.type === 'pray') {
      const v = cur && !isNaN(cur) ? +cur : 0;
      let btns = '';
      for (let i = 0; i <= 5; i++)
        btns += `<button class="pbt ${v===i?'on':''}" onclick="setPray('${slug}',${i})">${i===0?'0':Array(i).fill('ğŸ™').join('')}</button>`;
      inp = `<div class="prow" id="pr-${slug}">${btns}</div>`;
    } else if (s.type === 'notes') {
      const v = cur && cur !== 'â³' ? cur : '';
      inp = `<textarea class="ntarea" id="nt-${slug}" placeholder="Type notes, paste links, anythingâ€¦"
        oninput="markA('${slug}')">${v}</textarea>
        <div class="link-hint">ğŸ”— URLs you paste here become clickable links in History</div>`;
    } else { // number
      const v = cur && !isNaN(cur) ? +cur : 0;
      inp = `<div class="nrow">
        <button class="nbtn" onclick="adjN('${slug}',-1)">âˆ’</button>
        <input class="ninp" type="number" min="0" value="${v}" id="ni-${slug}" oninput="markA('${slug}')"/>
        <button class="nbtn" onclick="adjN('${slug}',1)">+</button>
        <button class="nbtn x10" onclick="adjN('${slug}',10)">+10</button>
      </div>`;
    }

    card.innerHTML = `
      <div class="etop">
        <div class="eico">${emj(s.name)}</div>
        <div><div class="elbl">${s.name}</div><div class="eq">${s.q}</div></div>
      </div>${inp}`;
    form.appendChild(card);
  });

  const btn = document.createElement('button');
  btn.className = 'subm'; btn.id = 'sbtn';
  btn.innerHTML = 'ğŸš€ SAVE TODAY\'S LOG';
  btn.onclick = submitLog;
  form.appendChild(btn);
}

function setTog(slug, val) {
  const card = document.getElementById('ec-' + slug);
  card.querySelectorAll('.tog').forEach(b => b.classList.remove('on'));
  card.querySelector('.tog.' + (val==='Yes'?'yes':'no')).classList.add('on');
  card.classList.add('answered'); card.dataset.val = val;
}
function markA(slug) {
  document.getElementById('ec-' + slug)?.classList.add('answered');
}
function adjN(slug, d) {
  const i = document.getElementById('ni-' + slug);
  if (i) { i.value = Math.max(0, +i.value + d); markA(slug); }
}
function setPray(slug, count) {
  const w = document.getElementById('pr-' + slug);
  if (!w) return;
  w.querySelectorAll('.pbt').forEach((b,i) => b.classList.toggle('on', i===count));
  markA(slug);
}

async function submitLog() {
  const btn = document.getElementById('sbtn');
  btn.disabled = true; btn.innerHTML = '<span class="sp"></span> SAVINGâ€¦';

  const values = {};
  subjects.forEach(s => {
    const slug = sl(s.name);
    let val;
    if (s.type === 'toggle') {
      val = document.querySelector(`#ec-${slug} .tog.yes.on`) ? 'Yes' : 'No';
    } else if (s.type === 'slider') {
      val = document.getElementById('sl-' + slug)?.value || '5';
    } else if (s.type === 'pray') {
      const btns = document.querySelectorAll(`#pr-${slug} .pbt`);
      let found = 0; btns.forEach((b,i) => { if (b.classList.contains('on')) found = i; });
      val = String(found);
    } else if (s.type === 'notes') {
      val = document.getElementById('nt-' + slug)?.value || '';
    } else {
      val = document.getElementById('ni-' + slug)?.value || '0';
    }
    values[s.name] = val;
  });

  const rec = todayRec();
  rec.checks = { ...rec.checks, ...values };
  const idx = history.findIndex(r => r.date === todayStr);
  if (idx === -1) history.unshift(rec); else history[idx] = rec;
  saveHistory();
  renderAll();
  toast('âœ… Saved!', 'ok');
  await pushLog(todayStr, values);

  btn.disabled = false; btn.innerHTML = 'ğŸš€ SAVE TODAY\'S LOG';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const head = document.getElementById('hhead');
  const body = document.getElementById('hbody');
  head.innerHTML = '<th>Date</th>';
  subjects.forEach(s => { const th=document.createElement('th'); th.textContent=s.name; head.appendChild(th); });

  const sorted = [...history].sort((a,b) => b.date.localeCompare(a.date));
  body.innerHTML = '';
  sorted.slice(0, 60).forEach(rec => {
    const tr  = document.createElement('tr');
    if (rec.date === todayStr) tr.className = 'today-row';
    const d   = new Date(rec.date + 'T12:00:00');
    const dl  = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const tod = rec.date === todayStr;
    let cells = `<td class="dcol">${dl}${tod?'<span style="font-size:.6rem;background:var(--gold);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px">TODAY</span>':''}</td>`;

    subjects.forEach(s => {
      const v    = rec.checks?.[s.name] ?? '';
      const good = isDone(s, v);
      let display = '';

      if (s.type === 'notes' && v && v !== 'â³') {
        // Render links as clickable, notes as text
        display = `<span class="cv note-val">${linkify(escHtml(v))}</span>`;
      } else {
        const txt = v===''||v==='â³' ? 'â€”' : v;
        display = `<span class="cv ${good?'g':'n'}">${txt}</span>`;
      }
      cells += `<td>${display}</td>`;
    });

    tr.innerHTML = cells; body.appendChild(tr);
  });
}

// Auto-detect URLs and make them clickable
function linkify(text) {
  return text.replace(/(https?:\/\/[^\s<>"]+)/g,
    '<a href="$1" target="_blank" rel="noopener">$1</a>');
}
function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReports() {
  const months = {}, weeks = {};
  history.forEach(rec => {
    if (!rec.date) return;
    const d  = new Date(rec.date + 'T12:00:00');
    const mk = d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
    const wk = wkKey(d);
    subjects.forEach(s => {
      const v = parseFloat(rec.checks?.[s.name]);
      if (!isNaN(v)) {
        months[mk] = months[mk] || {};
        months[mk][s.name] = (months[mk][s.name]||0) + v;
        weeks[wk]  = weeks[wk]  || {};
        weeks[wk][s.name]  = (weeks[wk][s.name] ||0) + v;
      }
    });
  });
  fillRpt('mhead','mbody','Month',months);
  fillRpt('whead','wbody','Week',weeks);
}
function fillRpt(hId,bId,lbl,data) {
  const h=document.getElementById(hId), b=document.getElementById(bId);
  h.innerHTML=`<th>${lbl}</th>`;
  subjects.forEach(s=>{const t=document.createElement('th');t.textContent=s.name;h.appendChild(t);});
  b.innerHTML='';
  Object.keys(data).sort().reverse().forEach(key=>{
    const tr=document.createElement('tr');
    let c=`<td class="dcol">${key}</td>`;
    subjects.forEach(s=>{const v=data[key][s.name];c+=`<td><span class="cv ${v>0?'g':'n'}">${v!=null?v:'â€”'}</span></td>`;});
    tr.innerHTML=c; b.appendChild(tr);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveUrl() {
  const url = document.getElementById('surl').value.trim();
  const st  = document.getElementById('urlst');
  if (!url) { st.textContent = 'âš ï¸ Please enter a URL'; return; }
  st.textContent = 'â³ Testing connectionâ€¦'; st.style.color = 'var(--muted)';
  SHEET_URL = url; localStorage.setItem(SK.url, url);
  try {
    const res  = await fetch(url + '?action=ping&t=' + Date.now());
    const data = await res.json();
    if (data.pong) {
      st.style.color = 'var(--green)'; st.textContent = 'âœ… Connected! Syncingâ€¦';
      sheetOk = true; syncFromSheet();
    } else throw new Error();
  } catch {
    st.style.color = 'var(--gold)'; st.textContent = 'âš ï¸ Ping failed. Trying full syncâ€¦';
    syncFromSheet();
  }
}
function clearUrl() {
  SHEET_URL = ''; localStorage.removeItem(SK.url);
  sheetOk = false; setSS('', 'LOCAL');
  document.getElementById('surl').value = '';
  document.getElementById('urlst').textContent = 'ğŸ”Œ Disconnected.';
  document.getElementById('urlst').style.color = 'var(--muted)';
  renderDash(); toast('Disconnected', '');
}

function renderSubjects() {
  const list = document.getElementById('slist');
  list.innerHTML = '';
  if (!subjects.length) { list.innerHTML='<p style="color:var(--muted);font-size:.82rem">No subjects yet.</p>'; return; }
  subjects.forEach(s => {
    const d = document.createElement('div');
    d.className = 'srow';
    d.innerHTML = `
      <div class="srow-info">
        <div class="sn">${s.name}</div>
        <div class="sd">Type: <b>${s.type}</b> Â· Default: <b>${s.def||'â€”'}</b><br>"${s.q}"</div>
      </div>
      <div class="srow-acts">
        <button class="icon-btn edit-btn" title="Edit" onclick="openEdit('${encodeURIComponent(s.name)}')">âœï¸</button>
        <button class="icon-btn del-btn" title="Delete" onclick="delSubj('${encodeURIComponent(s.name)}')">ğŸ—‘ï¸</button>
      </div>`;
    list.appendChild(d);
  });
}

function addSubject() {
  const name = document.getElementById('nn').value.trim();
  const q    = document.getElementById('nq').value.trim();
  const type = document.getElementById('nt').value;
  const def  = document.getElementById('nd').value.trim() || '0';
  if (!name) { toast('âš ï¸ Enter a name', 'err'); return; }
  if (subjects.find(s => s.name === name)) { toast('âš ï¸ Already exists', 'err'); return; }
  subjects.push({ name, type, q: q || `Update ${name}`, def });
  saveSubjects(); ensureToday(); renderSubjects(); renderAll();
  pushAdd(name);
  toast(`âœ… "${name}" added!`, 'ok');
  document.getElementById('nn').value = '';
  document.getElementById('nq').value = '';
}

function delSubj(encoded) {
  const name = decodeURIComponent(encoded);
  if (!confirm(`Delete "${name}"?`)) return;
  subjects = subjects.filter(s => s.name !== name);
  saveSubjects(); renderSubjects(); renderAll();
  pushDel(name);
  toast(`ğŸ—‘ï¸ "${name}" removed`, 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT SUBJECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(encoded) {
  const name = decodeURIComponent(encoded);
  const s    = subjects.find(x => x.name === name);
  if (!s) return;
  editingOld = name;
  document.getElementById('em-name').value = s.name;
  document.getElementById('em-q').value    = s.q;
  document.getElementById('em-type').value = s.type;
  document.getElementById('em-def').value  = s.def || '';
  openModal('editModal');
}

function saveEdit() {
  const newName = document.getElementById('em-name').value.trim();
  const q       = document.getElementById('em-q').value.trim();
  const type    = document.getElementById('em-type').value;
  const def     = document.getElementById('em-def').value.trim();
  if (!newName) { toast('âš ï¸ Name cannot be empty', 'err'); return; }

  const idx = subjects.findIndex(s => s.name === editingOld);
  if (idx === -1) return;

  // If name changed, update history records too
  if (newName !== editingOld) {
    history.forEach(rec => {
      if (rec.checks && rec.checks[editingOld] !== undefined) {
        rec.checks[newName] = rec.checks[editingOld];
        delete rec.checks[editingOld];
      }
    });
    saveHistory();
  }

  subjects[idx] = { name: newName, type, q: q || `Update ${newName}`, def };
  saveSubjects();
  closeModal('editModal');
  renderSubjects(); renderAll();
  toast(`âœ… "${newName}" updated!`, 'ok');
  editingOld = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
// Close modal on overlay click
document.querySelectorAll('.modal-ov').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target === ov) ov.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayRec() {
  return history.find(r => r.date === todayStr) || { date: todayStr, checks: {} };
}
function isDone(s, v) {
  if (v === undefined || v === null || v === '' || v === 'â³') return false;
  if (s.type === 'toggle') return v === 'Yes';
  if (s.type === 'pray')   return +v > 0;
  if (s.type === 'slider') return +v >= 6;
  if (s.type === 'notes')  return v.trim().length > 0;
  return +v > 0;
}
function fmtV(s, v) {
  if (s.type === 'toggle') return v==='Yes' ? 'âœ… Yes' : 'âŒ No';
  if (s.type === 'pray')   return `ğŸ™ ${v}/5`;
  if (s.type === 'slider') return `âš¡ ${v}/10`;
  if (s.type === 'notes')  return v.length > 24 ? v.slice(0,22)+'â€¦' : v;
  return `${v} logged`;
}
function emj(name) { const m = name.match(/\p{Emoji}/u); return m ? m[0] : name[0]; }
function sl(name)  { return name.replace(/[^\w]/g, '_'); }
function ldate(d)  {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function wkKey(d) {
  const s = new Date(d); s.setDate(d.getDate() - d.getDay());
  return s.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}
function guessType(n) {
  if (/pray/i.test(n)) return 'pray';
  if (/mood|energy|feel/i.test(n)) return 'slider';
  if (/note|link|url|ref|remark/i.test(n)) return 'notes';
  if (/push|count|rep|match|km|page/i.test(n)) return 'number';
  return 'toggle';
}
function bestStreak() {
  let best = 0, cur = 0;
  const sorted = [...history].sort((a,b) => a.date.localeCompare(b.date));
  sorted.forEach((rec, i) => {
    const tot = subjects.length || 1;
    let done = 0;
    subjects.forEach(s => { if (isDone(s, rec.checks?.[s.name])) done++; });
    if (done / tot >= .5) {
      if (i > 0) {
        const p = new Date(sorted[i-1].date+'T12:00:00');
        const c = new Date(rec.date+'T12:00:00');
        if ((c - p) / 86400000 > 1) cur = 1; else cur++;
      } else cur = 1;
      best = Math.max(best, cur);
    } else cur = 0;
  });
  return best;
}
function saveHistory()  { localStorage.setItem(SK.history,  JSON.stringify(history)); }
function saveSubjects() { localStorage.setItem(SK.subjects, JSON.stringify(subjects)); }
function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + (type||'');
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 3000);
}
function hideLs() {
  setTimeout(() => document.getElementById('ls').classList.add('gone'), 500);
}
</script>
</body>
</html>
